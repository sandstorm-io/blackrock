<!--
Sandstorm Blackrock
Copyright (c) 2015-2016 Sandstorm Development Group, Inc.
All Rights Reserved
-->

<template name="billingPrompt">
  {{!--
    Prompts the user to choose a plan, and a credit card with which to pay for it. Once the user
    has chosen something, their quota is updated.

    Data inputs:
    - reason:
        "voluntary": The user clicked a "sign up" button or is upgrading a plan. Optionally,
          `previousPlan` is also passed in.
        "outOfStorage": User ran out of storage.
        "outOfCompute": User ran out of compute units.
        "outOfGrains": Demo mode may limit the number of grains created.
        "customApp": User wants to install a custom app.
    - onComplete: Function to call on completion. The parameter is a boolean: true if the user
        successfully chose a new plan (in which case the action prompting billing should continue)
        or false if they dismissed the popup without choosing anything (in which case the action
        should be canceled).

    This will be included at the top level HTML like:

      {{#if billingPromptReason}}
        {{>billingPrompt reason=billingPromptReason onComplete=onBillingPromptDone
                         topbar=globalTopbar db=globalDb accountsUi=globalAccountsUi}}
      {{/if}}

    (In this example, `billingPromptReason` is probably some session variable.)
  --}}

  {{> sandstormTopbarItem name="billing-prompt" topbar=topbar
                          onlyPopup=true popupTemplate="_billingPromptPopup"
                          onDismiss=onDismiss}}
</template>

<template name="_billingPromptPopup">
  {{#if isComplete}}
    <h2>Success!</h2>
    <p class="success-note">You've changed your plan from <strong>{{oldPlan}}</strong> to
      <strong>{{planTitle myPlan}}</strong>.</p>

    {{> _billingSuccessBonusNotice }}
  {{else}}

  {{#if isDemoUser}}
    {{#if customApp}}
      <h2>Want more?</h2>

      <p class="custom-app">Demo users can only install <a href="https://apps.sandstorm.io/?host={{origin}}" target="_blank">apps from Sandstorm.io</a>.
        If you'd like to upload custom apps, please sign in.</p>
    {{else}}
      <h2>Want more?</h2>

      <p>You've reached the limits for a demo account.
        If you'd like to continue using Sandstorm and
        make your data permanent, please sign in.</p>

    {{/if}}
    <div class="login">
      {{> loginButtonsDialog accountsUi}}
    </div>

    <p class="alternatives">
      {{#unless customApp}}<a href="/demo-restart">Clear data and start over »</a><br>{{/unless}}
      <a href="https://sandstorm.io/install/">Install your own server »</a><br>
      (Sandstorm is Open Source!)
    </p>
  {{else}}
    {{#if involuntary}}
      {{#if customApp}}
        <h2>Want to upload your own apps?</h2>

        <p class="wider">Free-plan users can only install <a href="https://apps.sandstorm.io/?host={{origin}}" target="_blank">apps from Sandstorm.io</a>.
          If you'd like to upload custom apps, please upgrade your plan.</p>
      {{else}}
        <h2>Looks like you've run out of
          {{#if outOfGrains}}grains.{{/if}}
          {{#if outOfStorage}}storage.{{/if}}
          {{#if outOfCompute}}compute.{{/if}}
        </h2>
        <p>Don't worry, you can upgrade your plan.</p>
      {{/if}}
    {{else}}
      <h2>Choose a new plan</h2>
    {{/if}}

    {{>_billingPromptBody reason=reason onComplete=onCompleteWrapper
                          topbar=topbar db=db accountsUi=accountsUi}}
  {{/if}}
  {{/if}}
</template>

<template name="billingPromptFirstTime">
  <div class="first-time-billing-prompt">
    {{#if planChosen}}
      <h2>Success!</h2>
      <p class="success-note">You've selected <strong>{{planTitle myPlan}}</strong>.</p>

      {{> _billingSuccessBonusNotice }}
    {{else}}
      <h2>Choose a Plan</h2>

      <p>Welcome! Choose a plan to start creating.</p>

      {{>_billingPromptBody onComplete=onCompleteNoop topbar=topbar db=db accountsUi=accountsUi}}
    {{/if}}
  </div>
</template>

<template name="_billingSuccessBonusNotice">
  {{#with mailingListBonus=myMailingListBonus }}
    {{#if mailingListBonus.storage}}
      <p>Bonus! Because you're subscribed to our announcement list, we're giving you
        <strong>{{renderStorage MAILING_LIST_BONUS}} bonus storage</strong>.</p>
      <button class="continue">Continue</button>
    {{else}}
      <p>Get <strong>1GB bonus storage</strong> by subscribing to our announcement list.</p>
      <p class="subscribe-option">
        <button class="subscribe">Subscribe</button>
        <button class="continue">No thanks</button>
      </p>
    {{/if}}
  {{/with}}
</template>

<template name="_billingPromptBody">
  <div class="subscriptions">
    <a class="free-note" href="https://blog.sandstorm.io/news/2015-08-31-oasis-beta-launch.html" target="_blank">
      All plans are <strong>FREE</strong> during beta.
    </a>

    {{#each plans}}
      <div class="subscription {{_id}} {{#if isCurrent}}selected{{/if}} {{#if isSelecting}}selecting{{/if}} {{#if isFullscreen}}iframe-active{{/if}}">
        {{#if isShowingIframe}}
          <iframe class="mobile-iframe-hack {{#if isFullscreen}}fullscreen{{/if}}" src="{{paymentsUrl}}/checkout#{{checkoutData}}"></iframe>
        {{/if}}

        <p>{{#if isCurrent}}Current Plan{{else}}&nbsp;{{/if}}</p>
        <table>
          <tr><td>{{planTitle .}}</td></tr>
          <tr><td>
            {{#if price}}
              <p>${{renderDollars price}}</p>
              <p>/ month<br>(FREE during beta)</p>
            {{else}}
              <p>FREE</p>
              <p>&nbsp;<br>&nbsp;</p>
            {{/if}}
          </td></tr>
          <tr><td>
            <p>{{renderStorage storage}}</p>
            <p>Storage</p>
          </td></tr>
          <tr><td>
            <p>{{computeLabel}}</p>
            <p>Memory - {{renderCu compute}}CU*</p>
          </td></tr>
          <tr><td>
            <p>{{renderQuantity grains}}</p>
            <p># of Grains</p>
          </td></tr>
          <tr><td>
            <button>
              {{#if isCurrent}}
                Keep Plan
              {{else}}
                {{#if isUpgrade}}
                  Upgrade
                {{else}}
                  {{#if isDowngrade}}
                    Downgrade
                  {{else}}
                    Choose Plan
                  {{/if}}
                {{/if}}
              {{/if}}
            </button>
          </td></tr>
        </table>
      </div>
    {{/each}}
  </div>

  <div class="faq">
    <h3>F. A. Q.</h3>

    <div class="answer">
      <h4>*What is a compute unit?</h4>

      <p>A compute unit is 1GB of RAM used for one hour. Sandstorm apps only use RAM while
        you are actively using them, so 200 CU should be plenty for most users.
        <a href="https://blog.sandstorm.io/news/2015-01-14-compute-units.html" target="_blank">
        Learn more about compute units »</a></p>
    </div><div class="answer">
      {{#if planChosen}}
        <h4>What if I'm not ready to upgrade?</h4>

        <p>If you run out of space, you'll need to delete one of your existing grains before you can
          create a new one. Open a grain and click <span class="trash">the delete button</span> in
          the top bar. Or, since Sandstorm is Open Source you can
          <a href="https://sandstorm.io/install/" target="_blank">install your own server »</a></p>
      {{else}}
        <h4>Which plan should I choose?</h4>

        <p>If you're not sure which plan to choose, start with the free plan. You can always
          upgrade later. Also remember than Sandstorm is Open Source, so you can
          <a href="https://sandstorm.io/install/" target="_blank">install your own server »</a></p>
      {{/if}}
    </div>

    <a class="button" href="mailto:support@sandstorm.io" target="_blank">Contact Support</a>
  </div>
</template>

<template name="billingUsage">
  {{#if Template.subscriptionsReady}}
  <div class="usage">
    <h3>Usage</h3>
    {{#with plan=myPlan quota=myQuota used=myUsage referralBonus=myReferralBonus
            metadataBonus=myMetadataBonus mailingListBonus=myMailingListBonus}}{{#if plan}}
      <table>
        <tr>
          <td>Compute Units</td>
          <td>
            <div class="progress-bar">
              <div style="width: {{renderPercent used.compute quota.compute}}%"></div>
            </div>
            <div class="used">not tracked yet (beta)</div>
            <div class="total"><span class="amount">{{renderCu quota.compute}}</span> total</div>
          </td>
        </tr>
        <tr>
          <td>Storage</td>
          <td>
            <div class="progress-bar">
              <div style="width: {{renderPercent used.storage quota.storage}}%"></div>
            </div>
            <div class="used"><span class="amount">{{renderStoragePrecise used.storage}}</span> used</div>
            <div class="total"><span class="amount">{{renderStorage quota.storage}}</span> total</div>
          </td>
        </tr>
        <tr>
          <td>Grains</td>
          <td>
            <span class="grain-count"><span class="used">{{renderQuantity used.grains}}</span> out of <span class="total">{{renderQuantity quota.grains}}</span></span>
          </td>
        </tr>
      </table>
      <hr>
      {{#if mailingListBonus.storage}}
        <p class="bonus">
          Includes mailing list bonus: {{renderStorage mailingListBonus.storage}} storage
          <button class="unsubscribe">Unsubscribe</button>
        </p>
      {{/if}}
      {{#if referralBonus.storage}}
        <p class="bonus">
          Includes <a href="/referrals">referral bonus</a>: {{renderStorage referralBonus.storage}} storage
            {{#if referralBonus.grains}}
              and {{renderQuantity referralBonus.grains}} grains
            {{/if}}
        </p>
      {{/if}}
      {{#if metadataBonus.storage}}
        <p class="bonus">
          Includes gift from the admin: {{renderStorage metadataBonus.storage}} storage
            {{#if metadataBonus.grains}}
              and {{renderQuantity metadataBonus.grains}} grains
            {{/if}}
        </p>
      {{/if}}
      <p>Based on current plan: <span class="plan-name">{{planTitle plan}}</span>
        <button class="change-plan">change plan</button></p>
      {{#unless mailingListBonus.storage}}
        <p>Get {{renderStorage MAILING_LIST_BONUS}} bonus storage by subscribing to e-mail
          announcements (1-2 messages per month): <button class="subscribe">Subscribe</button></p>
      {{/unless}}
    {{/if}}{{/with}}
  </div>

  {{#if showPrompt}}
    {{>billingPrompt reason="voluntary" topbar=topbar db=db onComplete=promptClosed}}
  {{/if}}
  {{/if}}
</template>
